#setup
library(mirt)
library(tidyverse)
library(ggplot2)

options(scipen = 999)
options(stringsAsFactors = FALSE)

#this is just test data from a SQL query
outcomes_data <- read.csv("C:/Users/jennifer.brussow/My Documents/outcomes_data.csv")
names(outcomes_data) <- c("BookletID", "QuestionID", "ChoiceID", "BatchID", 
                          "Answer", "IsCorrect", "IsDemo", "atiDate", "OutcomeID", 
                          "QuestionOutcomeID", "AssessmentID", "TestName", 
                          "AssessmentStyleID", "TestTypeID", "OutcomeDescription",
                          "OutcomeTypeID", "OutcomeTypeName")

################################################################################
################################### QSEN #######################################
################################################################################

#using only data on QSEN outcomes
QSEN <- outcomes_data[which(outcomes_data$OutcomeTypeName == "QSEN"), 
                      c("BookletID", "QuestionID", "BatchID", 
                        "IsCorrect", "OutcomeID", 
                        "AssessmentID", "TestName", "OutcomeDescription",
                        "OutcomeTypeID", "OutcomeTypeName")]

#remove original dataset to save memory
rm(outcomes_data)
gc()

#mapping out which items load onto each factor
outcome_map <- unique(QSEN[, c("QuestionID", "OutcomeDescription")])

#eliminating extraneous columns before spreading data
QSEN_test <- QSEN[,c("BookletID", "QuestionID",  
                      "IsCorrect")]

#moving data into wide format for use with mirt
QSEN_wide <- QSEN_test %>%
  spread(QuestionID, IsCorrect)

#identifying items with 0 variance in responses
bad_items <- NULL

for(j in 2:ncol(QSEN_wide)){
  if(sum(!is.na(unique(QSEN_wide[, j]))) < 2){
    bad_items <- c(bad_items, colnames(QSEN_wide[j]))
  }
}

#removing those items from the item map
outcome_map <- outcome_map[which(!(outcome_map$QuestionID %in% bad_items)),]

#preparing lists of the items loading onto each factor
factors <- unique(outcome_map$OutcomeDescription)
factor_items <- vector("list", length(factors))

for(i in 1:length(factors)){
  factor_items[[i]] <- c(outcome_map[which(outcome_map[, "OutcomeDescription"] == factors[i]), "QuestionID"])
}

#formatting lists of items loading onto each factor for mirt model syntax
factor_syn <- vector("list", length(factors))
for(i in 1:length(factors)){
  factor_syn[[i]] <- paste0("F",i," = ", paste(factor_items[[i]], collapse = ", "))
}

#output the resulting string
sink(file = "QSEN_mirt_model.txt")
cat(paste0(unlist(factor_syn), sep = "\n"))
sink()

#this doesn't work yet - may need to include data in mirt.model() 
# model_syn <- mirt.model(file = "mirt_model.txt")

#pasted in from mirt_model.txt
model_syn <- "F1 = 7588387, 7588401, 7588402, 7588336, 7588337, 7588351, 7588353, 7588367, 7588393, 7588395, 7588345, 7588361, 7588427, 7588442, 7588445, 7588446, 7588451, 7588453, 7588471, 7588484, 7588487, 7588501, 7588332, 7588339, 7588348, 7588355, 7588364, 7588371, 7588408, 7588331, 7588338, 7588349, 7588381, 7588415, 7588422, 7588433, 7588447, 7588458, 7588465, 7588474, 7588490, 7588499, 7588459, 7588461, 7588462, 7588476, 7588477, 7588478, 7588479, 7588496, 7588509, 7588510, 7588502, 7588441, 7588448, 7588455, 7588473, 7588482, 3589568, 3589587, 3589550, 3589552, 3589553, 3589619, 3589636, 3589668, 3589684, 3589557, 3589571, 3589558, 3589562, 3589525, 3589528, 3589542, 3589543, 3589595, 3589609, 3589686, 3589523, 3589532, 3589546, 3589666, 3589660, 3589662, 3589565, 3589579, 3589581, 3589524, 3589588, 3589597, 3589613, 6983225, 6983226, 6983227, 6983228, 6983242, 6983244, 6983200, 6983202, 6983218, 6983220, 6983270, 6983285, 6983304, 6983335, 6983205, 6983207, 6983214, 6983216, 6983221, 6983232, 6983239, 6983241, 6983275, 6983280, 6983332, 6983355, 6983357, 6983364, 6983351, 6983352, 6983353, 6983354, 7724516, 6983375, 7724503, 7724505, 7724512, 6983277, 6983326, 6983328, 6983359, 6983360, 6983362, 6983377, 6983378, 6983379, 7724508, 7724510, 6983233, 6983331, 6983333, 6983340, 6983347, 6983356, 6983363, 7724506, 7724522, 7320969, 7320970, 7320971, 7320984, 7321002, 7321035, 7321037, 7321054, 7321068, 7321069, 7321071, 7321087, 7321088, 7321101, 7321102, 7321118, 7321121, 7321137, 7321138, 7320976, 7320979, 7320993, 7320996, 7321010, 7321045, 7321060, 7321061, 7321062, 7321063, 7321078, 7321079, 7321093, 7321094, 7321112, 7321130, 7320972, 7320974, 7320990, 7320992, 7320997, 7321006, 7321022, 7321031, 7321040, 7321049, 7321067, 7321081, 7321083, 7321090, 7321099, 7321106, 7321117, 7320982, 7321000, 7321014, 7321041, 7321048, 7321050, 7321064, 7321073, 7321075, 7321084, 7321089, 7321100, 7321123, 7321125, 5520797, 5520799, 5520822, 5520793, 5520886, 5520836, 5520862, 5520911, 5520920, 5520921, 5520938, 5520831, 5520833, 5520840, 5520842, 5520872, 5520924, 5520789, 5520791, 5520800, 5520965, 5520823, 5520825, 5520830, 5520841, 5520855, 5520857, 5520864, 5520914, 5520939, 5520964, 5470680, 5470682, 5470683, 5470714, 5470717, 5470800, 5470706, 5470707, 5470722, 5470670, 5470704, 5470736, 5470738, 5470743, 5470745, 5470818, 5470820, 5470703, 5470721, 5470755, 5470769, 5470794, 5470801, 5470805, 5470819, 5470846, 3133591, 3133600, 3133605, 3133592, 3133595, 3133611, 3133583, 3133588, 3133590, 7843759, 7843770, 7843760, 7843762, 7843776, 7843756, 7843765, 7843755, 7843766, 7843782, 7844779, 7844772, 7844773, 7844774, 7844783, 7844768, 7844775, 7844782, 3133608, 7494510, 7494528, 7494543, 7494516, 7494523, 7494525, 7494550, 7494557, 7494559, 7494564, 7494566, 7494582, 7494591, 7494546, 7494547, 7494562, 7494578, 7494579, 7494538, 7494555, 7494570, 7494571, 7673590, 7494585, 7494517, 7494522, 7494526, 7494531, 7494549, 7494551, 7494565, 7494567, 7494581, 7673589, 7673591, 3179220, 3179234, 3179235, 3179236, 3179245, 3179233, 3179238, 3179247, 3179221, 3179225, 3179232, 3179241, 7885560, 7885561, 5128268, 5128275, 5128273, 7891652, 7891654, 7891646, 7891649, 7891651, 5151987, 5151991, 3272453, 3272452, 3272461, 3272463, 3272477, 3272471, 3272476, 3272465
              F2 = 7588385, 7588335, 7588411, 7588412, 7588344, 7588397, 7588413, 7588369, 7588370, 7588417, 7588419, 7588420, 7588375, 7588377, 7588378, 7588426, 7588340, 7588347, 7588356, 7588460, 7588435, 7588436, 7588437, 7588454, 7588467, 7588469, 7588389, 7588398, 7588346, 7588373, 7588416, 7588421, 7588432, 7588439, 7588450, 7588466, 7588438, 7588449, 7588456, 7588463, 7588472, 7588483, 7588488, 7588508, 7588486, 7588503, 7588475, 7588480, 3589569, 3589584, 3589586, 3589518, 3589519, 3589520, 3589533, 3589534, 3589601, 3589620, 3589634, 3589651, 3589652, 3589654, 3589667, 3589575, 3589576, 3589577, 3589527, 3589564, 3589566, 3589573, 3589516, 3589548, 3589589, 3589596, 3589598, 3715178, 3589544, 3589545, 3589594, 3589623, 3589655, 3589657, 3589671, 3644112, 3589659, 3589661, 3589676, 3589678, 3589679, 3589556, 3589572, 3589515, 3589522, 3589529, 3589531, 3589554, 3589608, 3589633, 3589640, 3589656, 3589658, 1732528, 1732536, 6983229, 6983243, 6983259, 6983260, 6983219, 6983234, 6983235, 6983250, 6983252, 6983253, 6983267, 6983268, 6983269, 6983303, 6983367, 6983246, 6983264, 6983266, 6983271, 6983289, 6983291, 6983305, 6983350, 7724514, 6983368, 6983370, 7724501, 7724515, 7724528, 7724530, 6983276, 6983278, 6983279, 6983294, 6983343, 6983344, 6983346, 6983361, 6983376, 7724507, 6983213, 6983222, 6983238, 6983240, 6983247, 6983258, 6983263, 6983281, 6983297, 6983358, 6983365, 6983374, 7724504, 7724513, 7724520, 7320988, 7321020, 7321036, 7321038, 7321051, 7321053, 7321103, 7321104, 7321135, 7321136, 7320978, 7320994, 7320995, 7321012, 7321013, 7321026, 7321027, 7321028, 7321029, 7321077, 7321095, 7321096, 7320981, 7320983, 7320999, 7321015, 7321024, 7321033, 7321042, 7321058, 7321065, 7321072, 7321092, 7321097, 7321115, 7321122, 7321124, 7321110, 7321128, 7321143, 7321144, 7320973, 7320980, 7320998, 7321005, 7321007, 7321025, 7321055, 7321057, 7321059, 7321066, 7321080, 7321082, 7321091, 7321098, 7321114, 7321116, 7321132, 7321146, 5520801, 5520818, 5520819, 5520788, 5520792, 5520806, 5520808, 5520794, 5520795, 5520817, 5520881, 5520883, 5520890, 5520892, 5520897, 5520906, 5520824, 5520901, 5520903, 5520837, 5520895, 5520829, 5520856, 5520858, 5520867, 5520845, 5520861, 5520919, 5520936, 5520937, 5520952, 5520953, 5520910, 5520912, 5520913, 5520928, 5520929, 5520962, 5520954, 5520955, 5520798, 5520915, 5520922, 5520947, 5520956, 5520814, 5520816, 5520882, 5520884, 5520891, 5520898, 5520900, 5520839, 5520850, 5520866, 5520873, 5520916, 5520957, 5520959, 5470681, 5470675, 5470689, 5470697, 5470699, 5470700, 5470730, 5470705, 5470747, 5470748, 5470764, 5470765, 5470766, 5470767, 5470781, 5470782, 5470816, 5470817, 5470725, 5470739, 5470742, 5470756, 5470774, 5470775, 5470789, 5470792, 5470809, 5470841, 5470842, 5470684, 5470711, 5470718, 5470720, 5470793, 5470795, 5470829, 5470836, 5470669, 5470671, 5470678, 5470701, 5470735, 5470780, 5470785, 5470796, 5470838, 5470843, 5470835, 5470837, 3133594, 3133582, 3133586, 3133602, 3133604, 7843768, 7843769, 7843775, 7843777, 7843779, 7843758, 7843763, 7843757, 7843764, 7843780, 7844780, 7844781, 7844770, 7844788, 7844769, 7844777, 7844791, 7494507, 7494514, 7494532, 7494548, 7494519, 7494521, 7494536, 7494553, 7494589, 7673588, 7494511, 7494512, 7494513, 7494527, 7494545, 7494560, 7494577, 7673584, 7673586, 7494586, 7494588, 7494542, 7494556, 7494576, 7494583, 7494590, 7673582, 3179222, 3179218, 3179219, 3179228, 3179229, 3179243, 3179246, 3179224, 3179231, 3179240, 7885562, 7885564, 5151995, 5151990, 5151993, 3272462, 3272451, 3272458
              F3 = 7588383, 7588388, 7588368, 7588357, 7588430, 7588505, 3589610, 3589612, 3589615, 3589663, 1732605, 1732607, 7321018, 7321139, 5470815, 7844790, 7494539
              F4 = 7588390, 7588399, 7588406, 7588358, 7588363, 7588365, 7588374, 7588424, 7588431, 7588440, 7588384, 7588386, 7588403, 7588404, 7588350, 7588352, 7588354, 7588434, 7588452, 7588468, 7588470, 7588485, 7588504, 7588396, 7588400, 7588407, 7588341, 7588366, 7588380, 7588382, 7588423, 7588425, 7588457, 7588464, 7588489, 7588491, 7588498, 7588500, 7588507, 7588392, 7588394, 7588409, 7588410, 7588342, 7588359, 7588360, 7588362, 7588376, 7588379, 7588428, 7588429, 7588444, 7588492, 3589570, 3589517, 3589535, 3589536, 3589551, 3589600, 3589602, 3589603, 3589617, 3589618, 3589635, 3589637, 3589650, 3589653, 3589669, 3589670, 3589685, 3589559, 3589560, 3589561, 3589578, 3589592, 3589593, 3589611, 3589625, 3589626, 3589627, 3589628, 3589642, 3589580, 3589582, 3589521, 3589539, 3589555, 3589591, 3589605, 3589607, 3589614, 3589616, 3589621, 3589630, 3589632, 3589639, 3589664, 3589673, 3589687, 3589643, 3589675, 3589677, 3589692, 3589693, 3589694, 3644111, 3589680, 3589682, 3589689, 3589691, 3589563, 3589574, 3589583, 3589538, 3589540, 3589547, 3589549, 3589590, 3589599, 3589604, 3589606, 3589622, 3589624, 3589629, 3589631, 3589647, 3589649, 3589665, 3589672, 3589681, 3589683, 3589688, 3589690, 1732492, 1732508, 1732635, 1732640, 1732603, 1732654, 1732581, 1732630, 1732664, 6983217, 6983236, 6983237, 6983254, 6983223, 6983230, 6983248, 6983255, 6983257, 6983296, 6983298, 6983300, 6983307, 6983330, 1732493, 1732557, 6983209, 6983212, 6983287, 6983317, 6983336, 6983337, 6983369, 7724502, 7724517, 7724518, 6983341, 6983348, 6983366, 6983373, 7724519, 7724521, 7724523, 6983292, 6983293, 6983311, 6983312, 6983327, 6983329, 6983342, 6983345, 7724509, 7724525, 7724526, 7724527, 1732582, 1732600, 1732616, 1732657, 6983208, 6983215, 6983224, 6983231, 6983249, 6983256, 6983265, 6983288, 6983290, 6983306, 6983313, 6983322, 6983338, 6983349, 7724511, 7320985, 7320986, 7321001, 7321003, 7321019, 7321021, 7321052, 7321070, 7321085, 7321086, 7321105, 7321119, 7321120, 7321009, 7321011, 7321044, 7321046, 7321076, 7321008, 7321017, 7321047, 7321056, 7321074, 7321108, 7321133, 7321113, 7321126, 7321127, 7321147, 7320975, 7320989, 7320991, 7321016, 7321023, 7321030, 7321032, 7321034, 7321039, 7321107, 7321109, 7321134, 7321141, 5520787, 5520802, 5520803, 5520804, 5520820, 5520821, 5520885, 5520887, 5520888, 5520902, 5520904, 5520834, 5520838, 5520851, 5520852, 5520853, 5520854, 5520868, 5520869, 5520870, 5520871, 5520796, 5520809, 5520810, 5520811, 5520812, 5520813, 5520879, 5520896, 5520826, 5520827, 5520828, 5520843, 5520844, 5520846, 5520859, 5520860, 5520863, 5520926, 5520927, 5520930, 5520943, 5520944, 5520945, 5520946, 5520960, 5520963, 5520918, 5520935, 5520951, 5520790, 5520815, 5520899, 5520847, 5520849, 5520865, 5520908, 5520917, 5520931, 5520933, 5520940, 5520942, 5520949, 5520958, 5520805, 5520807, 5520880, 5520889, 5520905, 5520832, 5520848, 5520875, 5520909, 5520923, 5520925, 5520941, 5520950, 5470673, 5470690, 5470698, 5470715, 5470731, 5470732, 5470733, 5470734, 5470750, 5470797, 5470814, 5470831, 5470708, 5470709, 5470723, 5470724, 5470740, 5470741, 5470758, 5470772, 5470807, 5470808, 5470822, 5470823, 5470824, 5470825, 5470826, 5470840, 5470668, 5470679, 5470686, 5470688, 5470693, 5470695, 5470702, 5470713, 5470727, 5470754, 5470763, 5470768, 5470779, 5470788, 5470827, 5470685, 5470687, 5470694, 5470710, 5470719, 5470726, 5470728, 5470746, 5470751, 5470753, 5470762, 5470771, 5470821, 5470832, 5470828, 5470844, 3133589, 3133598, 3133607, 3133584, 3133585, 3133587, 3133603, 3133593, 3133609, 3133610, 3133597, 7843767, 7843761, 7843778, 7843772, 7843774, 7843781, 7843783, 7843771, 7843773, 7844778, 7844771, 7844767, 7844776, 7844795, 7844793, 3133606, 7494537, 7494552, 7494534, 7494529, 7494544, 7494561, 7494563, 7494580, 7673585, 7494568, 7494569, 7494572, 7673587, 7494508, 7494515, 7494524, 7494558, 3179226, 3179227, 3179244, 3179237, 3179223, 3179230, 3179239, 7885563, 5128272, 5128274, 3655082, 5128269, 5128270, 5128271, 5128276, 7891647, 7891653, 7891648, 5151986, 5151988, 5151989, 5151994, 5151992, 3272455, 3272460, 3272469, 3272454, 3272470, 3272472, 3272479, 3272478, 3272480, 3272456, 3272457, 3272459, 3272473, 3272474, 3272475, 3272466, 3272467, 3272468
              F5 = 7588495, 3589585, 3589644, 3589674, 6983261, 6983262, 6983371, 7321129, 5520893, 5520894, 5470777, 5470776, 3133596, 7844796, 7494575
              F6 = 7588343, 7588443, 7588493, 7588494, 7588334, 7588418, 7588372, 7588481, 7588497, 7588506, 7588391, 7588405, 7588414, 3589567, 3589641, 3589646, 3589648, 3589645, 3589638, 1732512, 1732514, 1732499, 1732619, 1732650, 6983301, 6983334, 7724524, 6983272, 6983299, 6983372, 7724529, 7320977, 7320987, 7321004, 7321131, 7321140, 7321142, 7321043, 7321111, 7321145, 5520835, 5520876, 5520877, 5520878, 5520961, 5520874, 5520907, 5520932, 5520934, 5470757, 5470761, 5470786, 5470813, 5470716, 5470759, 5470760, 7844787, 7844785, 7844792, 7844794, 7844789, 7844784, 7673583, 7494574, 7494554, 3179242, 7891650"

#run analysis
model <- mirt(data=QSEN_wide[, as.character(unlist(factor_items))], 
              model=model_syn, itemtype = "2PL", method = "QMCEM",
              technical = list(removeEmptyRows = TRUE, NCYCLES = 500))

factor_load <- summary(model)$rotF

item_coef <- coef(model, simplify = TRUE, IRTpars = TRUE)$items

item_f_load <- vector("list", length = length(factor_items))

for(i in 1:length(item_f_load)){
  item_f_load[[i]] <- as.data.frame(factor_load[which(rownames(factor_load) %in% factor_items[[i]]),])
}

# colors = c("#c74e46", "#eb8031", "#2962ff", "#675e5c", "#a5959a", "#e0e55b")

gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

colors = gg_color_hue(6)

pdf("K:/AscendKC/Corp/R_and_D/1-USERS/Jennifer Brussow/Outcome Modeling/QSEN_exploratory.pdf")
#Factor 1
ggplot(data = item_f_load[[1]], aes(x = F1)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[1]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("Nursing_Process: ", factors[1], " - Item Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[1]]$F1), 3),
                        ", SD = ", round(sd(item_f_load[[1]]$F1), 3))) +
  theme_bw()

#Factor 2
ggplot(data = item_f_load[[2]], aes(x = F2)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[2]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("QSEN: ", factors[2], " - Item Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[2]]$F2), 3),
                        ", SD = ", round(sd(item_f_load[[2]]$F2), 3))) +
  theme_bw()

#Factor 3
ggplot(data = item_f_load[[3]], aes(x = F3)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[3]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("QSEN: ", factors[3], " - Item Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[3]]$F3), 3),
                        ", SD = ", round(sd(item_f_load[[3]]$F3), 3))) +
  theme_bw()

#Factor 4
ggplot(data = item_f_load[[4]], aes(x = F4)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[4]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("QSEN: ", factors[4], " - Item Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[4]]$F4), 3),
                        ", SD = ", round(sd(item_f_load[[4]]$F4), 3))) +
  theme_bw()

#Factor 5
ggplot(data = item_f_load[[5]], aes(x = F5)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[5]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("QSEN: ", factors[5], " - Item Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[5]]$F5), 3),
                        ", SD = ", round(sd(item_f_load[[5]]$F5), 3))) +
  theme_bw()

#Factor 6
ggplot(data = item_f_load[[6]], aes(x = F6)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[6]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("QSEN: ", factors[6], " - Item Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[6]]$F6), 3),
                        ", SD = ", round(sd(item_f_load[[6]]$F6), 3))) +
  theme_bw()

dev.off()


################################################################################
########################### Nursing_Process ####################################
################################################################################

#using only data on Nursing_Process outcomes
Nursing_Process <- outcomes_data[which(outcomes_data$OutcomeTypeName == "Nursing Process"), 
                      c("BookletID", "QuestionID", "BatchID", 
                        "IsCorrect", "OutcomeID", 
                        "AssessmentID", "TestName", "OutcomeDescription",
                        "OutcomeTypeID", "OutcomeTypeName")]

#remove original dataset to save memory
rm(outcomes_data)
gc()

#mapping out which items load onto each factor
outcome_map <- unique(Nursing_Process[, c("QuestionID", "OutcomeDescription")])

#eliminating extraneous columns before spreading data
Nursing_Process_test <- Nursing_Process[,c("BookletID", "QuestionID",  
                     "IsCorrect")]

#moving data into wide format for use with mirt
Nursing_Process_wide <- Nursing_Process_test %>%
  spread(QuestionID, IsCorrect)

#identifying items with 0 variance in responses
bad_items <- NULL

for(j in 2:ncol(Nursing_Process_wide)){
  if(sum(!is.na(unique(Nursing_Process_wide[, j]))) < 2){
    bad_items <- c(bad_items, colnames(Nursing_Process_wide[j]))
  }
}

#removing those items from the item map
outcome_map <- outcome_map[which(!(outcome_map$QuestionID %in% bad_items)),]

#preparing lists of the items loading onto each factor
factors <- unique(outcome_map$OutcomeDescription)
factor_items <- vector("list", length(factors))

for(i in 1:length(factors)){
  factor_items[[i]] <- c(outcome_map[which(outcome_map[, "OutcomeDescription"] == factors[i]), "QuestionID"])
}

#formatting lists of items loading onto each factor for mirt model syntax
factor_syn <- vector("list", length(factors))
for(i in 1:length(factors)){
  factor_syn[[i]] <- paste0("F",i," = ", paste(factor_items[[i]], collapse = ", "))
}

#output the resulting string
sink(file = "Nursing_Process_mirt_model.txt")
cat(paste0(unlist(factor_syn), sep = "\n"))
sink()

#this doesn't work yet - may need to include data in mirt.model() 
# model_syn <- mirt.model(file = "mirt_model.txt")

#pasted in from mirt_model.txt
#Nursing Process - only keeping 2013 factors
model_syn <- "F1 = 7588384, 7588401, 7588404, 7588392, 7588393, 7588395, 7588410, 7588411, 7588343, 7588344, 7588406, 7588408, 7588331, 7588338, 7588418, 7588419, 7588360, 7588361, 7588362, 7588379, 7588347, 7588363, 7588365, 7588374, 7588381, 7588428, 7588429, 7588442, 7588444, 7588446, 7588460, 7588476, 7588434, 7588435, 7588467, 7588468, 7588469, 7588405, 7588407, 7588341, 7588346, 7588371, 7588373, 7588380, 7588382, 7588423, 7588430, 7588441, 7588455, 7588457, 7588422, 7588424, 7588431, 7588438, 7588449, 7588456, 7588465, 7588474, 7588481, 7588488, 7588490, 7588506, 7588471, 7588484, 7588501, 7588502, 7588504, 7588480, 7588498, 7588505, 7588478, 7588492, 7588494, 3589568, 3589551, 3589552, 3589553, 3589601, 3589603, 3589618, 3589619, 3589634, 3589635, 3589654, 3589670, 3589558, 3589560, 3589575, 3589576, 3589571, 3589580, 3589686, 3589523, 3589546, 3589548, 3589589, 3589596, 3589598, 3589605, 3589543, 3589611, 3589628, 3589657, 3589671, 3589673, 3589680, 3589682, 3589689, 3589691, 3644112, 3589660, 3589662, 3589675, 3589678, 3589693, 3644111, 3589579, 3589581, 3589583, 3589540, 3589554, 3589597, 3589599, 3589604, 3589608, 3589615, 3589622, 3589633, 3589658, 3589688, 3589690, 6983209, 6983225, 6983244, 6983261, 6983202, 6983218, 6983219, 6983237, 6983254, 6983267, 6983285, 6983301, 6983304, 6983317, 6983354, 6983205, 6983216, 6983232, 6983257, 6983264, 6983266, 6983271, 6983280, 6983291, 6983298, 6983300, 6983307, 6983348, 6983350, 6983355, 6983364, 6983366, 6983373, 7724503, 7724505, 7724512, 6983369, 6983370, 7724502, 7724515, 7724521, 6983277, 6983278, 6983279, 6983293, 6983311, 6983312, 6983326, 6983359, 6983361, 6983377, 7724524, 7724525, 7724526, 6983215, 6983222, 6983224, 6983233, 6983247, 6983249, 6983263, 6983288, 6983290, 6983297, 6983299, 6983306, 6983313, 6983322, 6983331, 6983333, 6983340, 6983356, 6983358, 6983374, 7724504, 7724511, 7724513, 7724522, 7724529, 7320971, 7320984, 7320986, 7321018, 7321019, 7321021, 7321035, 7321037, 7321052, 7321053, 7321069, 7321070, 7321085, 7321086, 7321101, 7321118, 7321119, 7320978, 7320994, 7320995, 7321009, 7321028, 7321044, 7321045, 7321046, 7321062, 7321077, 7321096, 7321110, 7320981, 7320990, 7321006, 7321008, 7321015, 7321017, 7321042, 7321049, 7321056, 7321074, 7321090, 7321092, 7321097, 7321099, 7321106, 7321115, 7321133, 7321140, 7321142, 7321147, 7321111, 7321127, 7321144, 7320975, 7321000, 7321016, 7321023, 7321025, 7321032, 7321034, 7321055, 7321066, 7321073, 7321082, 7321100, 7321107, 7321109, 7321139, 5520803, 5520804, 5520819, 5520792, 5520793, 5520817, 5520897, 5520906, 5520831, 5520840, 5520885, 5520836, 5520838, 5520851, 5520813, 5520893, 5520895, 5520828, 5520829, 5520843, 5520844, 5520856, 5520858, 5520865, 5520853, 5520870, 5520846, 5520860, 5520863, 5520935, 5520952, 5520911, 5520912, 5520913, 5520927, 5520928, 5520929, 5520943, 5520944, 5520945, 5520946, 5520961, 5520963, 5520955, 5520789, 5520908, 5520922, 5520924, 5520931, 5520933, 5520940, 5520949, 5520956, 5520965, 5520807, 5520889, 5520898, 5520900, 5520823, 5520857, 5520909, 5520914, 5520923, 5520925, 5520932, 5520934, 5520941, 5520950, 5520964, 5470675, 5470690, 5470699, 5470717, 5470731, 5470733, 5470781, 5470814, 5470815, 5470831, 5470832, 5470707, 5470723, 5470724, 5470739, 5470741, 5470772, 5470789, 5470792, 5470808, 5470809, 5470822, 5470824, 5470825, 5470826, 5470686, 5470704, 5470711, 5470738, 5470768, 5470788, 5470793, 5470813, 5470836, 5470687, 5470701, 5470710, 5470719, 5470721, 5470726, 5470746, 5470753, 5470776, 5470780, 5470785, 5470794, 5470805, 5470821, 5470843, 5470828, 5470837, 5470844, 5470846, 7843759, 7843770, 7843761, 7843775, 7843776, 7843763, 7843765, 7843774, 7843755, 7843766, 7843771, 7843780, 7844778, 7844779, 7844780, 7844788, 7844789, 7844767, 7844774, 7844776, 7844783, 7844792, 7844795, 7844796, 7844794, 7844768, 7844784, 7844793, 7494510, 7494507, 7494514, 7494534, 7494539, 7494536, 7494537, 7494555, 7494568, 7494569, 7494559, 7494566, 7494591, 7673583, 7673590, 7494512, 7494513, 7494527, 7494528, 7494529, 7494543, 7494544, 7494546, 7494563, 7494578, 7673586, 7494570, 7494571, 7494572, 7494588, 7494508, 7494524, 7494526, 7494542, 7494551, 7494556, 7494574, 7494576, 7673589, 7673591, 5128272, 3655082, 5128269, 5128275, 5128271, 5128273, 7891647, 7891652, 7891654, 7891653, 7891649, 5151987, 5151991, 5151992
              F2 = 7588385, 7588403, 7588336, 7588412, 7588388, 7588333, 7588368, 7588369, 7588375, 7588377, 7588426, 7588349, 7588358, 7588415, 7588462, 7588452, 7588389, 7588400, 7588414, 7588332, 7588366, 7588432, 7588473, 7588463, 7588508, 7588486, 7588487, 7588503, 7588482, 7588507, 7588479, 7588510, 3589569, 3589585, 3589586, 3589587, 3589519, 3589520, 3589533, 3589534, 3589550, 3589620, 3589651, 3589667, 3589684, 3589525, 3589527, 3589566, 3589521, 3589532, 3589539, 3589616, 3589542, 3589544, 3589545, 3589595, 3589609, 3589610, 3589612, 3589644, 3589632, 3589646, 3589648, 3589676, 3589556, 3589563, 3589529, 3589531, 3589547, 3589549, 3589590, 3589629, 3589647, 3589649, 3589683, 6983212, 6983226, 6983229, 6983242, 6983260, 6983200, 6983268, 6983270, 6983336, 6983221, 6983275, 6983330, 6983341, 7724514, 7724501, 7724518, 6983294, 6983329, 6983343, 6983345, 6983346, 6983360, 6983362, 7724510, 6983213, 6983281, 7724520, 7320968, 7320969, 7320987, 7320988, 7321002, 7321003, 7321020, 7321036, 7321038, 7321051, 7321054, 7321071, 7321087, 7321088, 7321102, 7321103, 7321104, 7321121, 7320976, 7320996, 7321012, 7321013, 7321076, 7321093, 7321095, 7321033, 7321072, 7321081, 7321122, 7321112, 7321143, 7320980, 7320998, 7321007, 7321080, 7321084, 7321098, 7321125, 7321141, 5520786, 5520787, 5520801, 5520808, 5520815, 5520822, 5520824, 5520821, 5520901, 5520837, 5520812, 5520877, 5520878, 5520879, 5520826, 5520827, 5520849, 5520871, 5520845, 5520862, 5520919, 5520920, 5520937, 5520951, 5520926, 5520930, 5520962, 5520798, 5520814, 5520839, 5520850, 5520916, 5520959, 5470667, 5470681, 5470697, 5470698, 5470730, 5470705, 5470782, 5470800, 5470817, 5470708, 5470709, 5470725, 5470807, 5470842, 5470668, 5470684, 5470695, 5470718, 5470720, 5470743, 5470754, 5470761, 5470671, 5470703, 5470760, 5470762, 5470796, 7843756, 7844770, 7844769, 7844777, 7494525, 7494532, 7494550, 7494521, 7494552, 7494553, 7494582, 7494589, 7494545, 7494547, 7494560, 7494562, 7494549, 7494583, 7885564, 7885560, 5128268, 5128270, 7891648, 7891650, 5151988, 5151995, 5151994, 5151990
              F3 = 7588386, 7588334, 7588337, 7588345, 7588390, 7588413, 7588340, 7588352, 7588417, 7588420, 7588378, 7588372, 7588443, 7588461, 7588477, 7588436, 7588453, 7588454, 7588357, 7588364, 7588416, 7588439, 7588448, 7588450, 7588440, 7588472, 7588497, 7588499, 7588495, 3589584, 3589517, 3589600, 3589637, 3589652, 3589668, 3589669, 3589577, 3589564, 3589573, 3589582, 3589687, 3715178, 3589626, 3589627, 3589642, 3589643, 3589623, 3589639, 3589641, 3589655, 3589659, 3589692, 3589694, 3589565, 3589572, 3589574, 3589522, 3589538, 3589588, 3589638, 3589640, 3589656, 3589665, 6983243, 6983259, 6983262, 6983234, 6983235, 6983250, 6983252, 6983303, 6983334, 6983335, 6983351, 6983368, 6983246, 6983248, 6983296, 6983305, 6983357, 6983375, 7724519, 7724516, 7724530, 6983276, 6983327, 6983328, 6983344, 6983376, 7724507, 7724508, 7724509, 6983208, 6983238, 6983240, 6983256, 6983258, 6983265, 6983272, 6983349, 6983363, 6983365, 6983372, 7724506, 7320970, 7321001, 7321004, 7321068, 7321136, 7320977, 7320979, 7321010, 7321026, 7321029, 7321043, 7321063, 7321079, 7320974, 7320992, 7321031, 7321040, 7321108, 7321131, 7321129, 7320973, 7320982, 7320991, 7321005, 7321030, 7321057, 7321059, 7321075, 7321091, 7321145, 7321146, 5520802, 5520818, 5520788, 5520806, 5520881, 5520883, 5520890, 5520892, 5520842, 5520887, 5520888, 5520902, 5520904, 5520894, 5520896, 5520847, 5520867, 5520874, 5520852, 5520869, 5520859, 5520861, 5520936, 5520953, 5520910, 5520791, 5520915, 5520958, 5520816, 5520882, 5520891, 5520907, 5520841, 5520848, 5520855, 5520873, 5520875, 5520957, 5470689, 5470700, 5470732, 5470748, 5470764, 5470765, 5470766, 5470816, 5470722, 5470740, 5470742, 5470756, 5470757, 5470758, 5470774, 5470775, 5470727, 5470736, 5470777, 5470779, 5470786, 5470795, 5470669, 5470685, 5470728, 5470735, 5470751, 5470771, 5470838, 7843768, 7843769, 7843778, 7843758, 7843772, 7843757, 7843764, 7843773, 7843782, 7844781, 7844771, 7844772, 7844773, 7844785, 7844775, 7844791, 7494511, 7494519, 7494516, 7494548, 7494538, 7494554, 7494564, 7494575, 7494561, 7494577, 7673584, 7673582, 7885562, 5151986, 5151993
              F4 = 7588387, 7588342, 7588359, 7588383, 7588397, 7588350, 7588370, 7588376, 7588356, 7588445, 7588437, 7588470, 7588396, 7588398, 7588339, 7588348, 7588425, 7588464, 7588483, 7588485, 7588475, 7588489, 7588500, 7588493, 3589567, 3589570, 3589535, 3589536, 3589602, 3589561, 3589562, 3589578, 3589528, 3589555, 3589621, 3589593, 3589645, 3589666, 3589606, 3589624, 3589674, 3589681, 6983228, 6983217, 6983220, 6983269, 6983287, 6983337, 6983367, 6983207, 7724517, 6983292, 7724527, 6983231, 6983338, 7320985, 7321105, 7321120, 7321135, 7321137, 7321011, 7321027, 7321078, 7320972, 7320983, 7320999, 7321024, 7321047, 7321058, 7321124, 7321113, 7321050, 7321114, 7321116, 7321134, 5520797, 5520799, 5520796, 5520833, 5520820, 5520903, 5520834, 5520835, 5520810, 5520811, 5520876, 5520868, 5520918, 5520954, 5520917, 5520947, 5520832, 5520866, 5470680, 5470682, 5470714, 5470715, 5470716, 5470747, 5470797, 5470759, 5470841, 5470679, 5470693, 5470702, 5470713, 5470829, 5470694, 5470835, 7843767, 7843760, 7843777, 7843779, 7843781, 7844790, 7844782, 7494580, 7673587, 7494586, 7494515, 7494522, 7494531, 7494558, 7885561, 7885563, 5128274, 7891651
              F5 = 7588399, 7588433, 7588447, 7588458, 7588402, 7588335, 7588351, 7588353, 7588354, 7588367, 7588451, 7588391, 7588355, 7588421, 7588466, 7588491, 7588394, 7588409, 7588427, 7588459, 7588496, 7588509, 3589518, 3589617, 3589636, 3589650, 3589653, 3589685, 3589559, 3589592, 3589594, 3589625, 3589557, 3589516, 3589591, 3589607, 3589614, 3589630, 3589664, 3589661, 3589677, 3589679, 3589515, 3589524, 3589613, 3589631, 3589663, 3589672, 6983236, 6983253, 6983214, 6983223, 6983230, 6983239, 6983241, 6983255, 6983289, 6983332, 6983227, 6983352, 6983353, 6983371, 7724528, 6983342, 6983378, 6983379, 6983347, 7321138, 7320993, 7321060, 7321061, 7321094, 7320997, 7321022, 7321065, 7321067, 7321083, 7321117, 7321126, 7321128, 7321130, 7320989, 7321014, 7321039, 7321041, 7321048, 7321064, 7321089, 7321123, 7321132, 5520886, 5520854, 5520794, 5520795, 5520809, 5520960, 5520921, 5520938, 5520790, 5520899, 5520872, 5520942, 5520800, 5520805, 5520880, 5520884, 5520905, 5520825, 5520830, 5520864, 5520939, 5470673, 5470683, 5470734, 5470750, 5470767, 5470706, 5470823, 5470840, 5470670, 5470688, 5470745, 5470763, 5470818, 5470820, 5470827, 5470678, 5470755, 5470769, 5470801, 5470819, 7843762, 7843783, 7844787, 7494523, 7494557, 7494579, 7494585, 7673585, 7673588, 7494517, 7494565, 7494567, 7494581, 7494590, 5128276, 7891646, 5151989"

#run analysis
model <- mirt(data=Nursing_Process_wide[, as.character(unlist(factor_items))], 
              model=model_syn, itemtype = "2PL", method = "QMCEM",
              technical = list(removeEmptyRows = TRUE, NCYCLES = 500))

factor_load <- summary(model)$rotF

item_coef <- coef(model, simplify = TRUE, IRTpars = TRUE)$items

item_f_load <- vector("list", length = length(factor_items))

for(i in 1:length(item_f_load)){
  item_f_load[[i]] <- as.data.frame(factor_load[which(rownames(factor_load) %in% factor_items[[i]]),])
}

# colors = c("#c74e46", "#eb8031", "#2962ff", "#675e5c", "#a5959a", "#e0e55b")

gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

colors = gg_color_hue(6)

pdf("K:/AscendKC/Corp/R_and_D/1-USERS/Jennifer Brussow/Outcome Modeling/Nursing_Process_exploratory.pdf")
#Factor 1
ggplot(data = item_f_load[[1]], aes(x = F1)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[1]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("Nursing Process: ", factors[1], "\nItem Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[1]]$F1), 3),
                        ", SD = ", round(sd(item_f_load[[1]]$F1), 3))) +
  theme_bw()

#Factor 2
ggplot(data = item_f_load[[2]], aes(x = F2)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[2]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("Nursing Process: ", factors[2], " - Item Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[2]]$F2), 3),
                        ", SD = ", round(sd(item_f_load[[2]]$F2), 3))) +
  theme_bw()

#Factor 3
ggplot(data = item_f_load[[3]], aes(x = F3)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[3]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("Nursing Process: ", factors[3], "\nItem Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[3]]$F3), 3),
                        ", SD = ", round(sd(item_f_load[[3]]$F3), 3))) +
  theme_bw()

#Factor 4
ggplot(data = item_f_load[[4]], aes(x = F4)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[4]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("Nursing Process: ", factors[4], "\nItem Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[4]]$F4), 3),
                        ", SD = ", round(sd(item_f_load[[4]]$F4), 3))) +
  theme_bw()

#Factor 5
ggplot(data = item_f_load[[5]], aes(x = F5)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[5]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("Nursing Process: ", factors[5], "\nItem Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[5]]$F5), 3),
                        ", SD = ", round(sd(item_f_load[[5]]$F5), 3))) +
  theme_bw()


dev.off()


person_scores <- fscores(model, QMC = TRUE, converge_info = TRUE)
cov(person_scores[,1:5])

