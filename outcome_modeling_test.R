#setup
library(mirt)
library(tidyverse)
library(ggplot2)

options(scipen = 999)
options(stringsAsFactors = FALSE)

date <- format.Date(Sys.Date(), "%Y%m%d")

# outcomes_data <- read.table("item-level_RN-CP_outcome-scores.txt",
#                             sep = ",", header = TRUE, as.is = TRUE,
#                             strip.white = TRUE, fill = TRUE,
#                             blank.lines.skip = TRUE)
# 
# saveRDS(outcomes_data, "item-level_RN-CP_outcome-scores.rds")

outcomes_data <- readRDS("item-level_RN-CP_outcome-scores.rds")

gc()

names(outcomes_data)[1] <- gsub("Ã¯..", "", names(outcomes_data)[1])

################################################################################
################################### QSEN #######################################
################################################################################

#using only data on QSEN outcomes
QSEN <- outcomes_data[which(outcomes_data$OutcomeTypeName == "QSEN"), 
                      c("BookletID", "qbtbQuestionID",  
                        "IsCorrect", "OutcomeDescription")]

#mapping out which items load onto each factor
outcome_map <- unique(QSEN[, c("qbtbQuestionID", "OutcomeDescription")])

#eliminating extraneous columns before spreading data
QSEN <- QSEN[,c("BookletID", "qbtbQuestionID",  
                      "IsCorrect")]

#moving data into wide format for use with mirt
QSEN <- QSEN %>%
  spread(qbtbQuestionID, IsCorrect)

#identifying items with 0 variance in responses
bad_items <- NULL

for(j in 2:ncol(QSEN)){
  if(sum(!is.na(unique(QSEN[, j]))) < 2){
    bad_items <- c(bad_items, colnames(QSEN[j]))
  }
}

#removing those items from the item map
outcome_map <- outcome_map[which(!(outcome_map$qbtbQuestionID %in% bad_items)),]

#preparing lists of the items loading onto each factor
factors <- unique(outcome_map$OutcomeDescription)
factor_items <- vector("list", length(factors))

for(i in 1:length(factors)){
  factor_items[[i]] <- c(outcome_map[which(outcome_map[, "OutcomeDescription"] == factors[i]), "qbtbQuestionID"])
}

#formatting lists of items loading onto each factor for mirt model syntax
factor_syn <- vector("list", length(factors))
for(i in 1:length(factors)){
  factor_syn[[i]] <- paste0("F",i," = ", paste(factor_items[[i]], collapse = ", "))
}

#output the resulting string
sink(file = "QSEN_mirt_model.txt")
cat(paste0(unlist(factor_syn), sep = "\n"))
sink()

#this doesn't work yet - may need to include data in mirt.model() 
# model_syn <- mirt.model(file = "mirt_model.txt")
# model_syn <- readChar("QSEN_mirt_model.txt", file.info("QSEN_mirt_model.txt")$size)

#pasted in from QSEN_mirt_model.txt
model_syn <- "F1 = 134984, 135693, 134991, 135017, 190570, 194244, 135763, 194320, 197196, 134539, 135180, 135260, 135587, 135732, 197387, 203303, 220527, 190463, 135213, 135317, 135321, 135551, 135664, 137320, 137327, 166216, 166217, 164860, 135346, 206345, 134536, 135226, 135474, 135492, 135569, 137290, 161365, 161367, 161370, 135065, 135316, 135365, 135487, 135657, 135697, 137388, 166215, 135358, 135043, 135210, 135669, 141577, 160512, 166224, 166937, 135480, 168552, 197220, 231268, 134152, 203296, 190584, 134952, 133900, 134538, 134546, 135254, 135437, 135590, 135751, 135239, 137351, 149998, 189900, 135342, 135393, 230165, 230485, 231293, 135482, 167416, 135518, 230490, 168560, 229863, 228441, 203310, 205763, 231451, 134988, 221178, 221353, 197602, 221354, 135133, 221355, 134729, 197971, 164844, 134987, 160523, 198573, 135047, 135345, 160521, 169627, 133988, 134569, 135086, 135491, 160528, 135722, 135455, 167527, 160522, 135563, 135568, 197932, 167533, 197216, 167537, 164840, 231445, 134699, 135658, 135280, 197757, 135519, 233540, 135628, 135750, 135617, 203308, 198179, 135626, 198574, 198181, 135532, 135623, 135184, 135318, 135633, 150314, 203288, 134465, 135176, 169612, 197418, 135642, 135654, 135740, 135558, 135159, 137294, 135577, 135102, 135445, 206334, 198655, 135084, 135248, 137323, 134809, 135356, 135368, 135663, 135721, 166209, 166212, 172827, 167526, 137293, 172833, 134616, 137319, 177393, 135661, 135169, 135170, 135246, 135653, 135364, 135377, 133913, 192305, 135453, 231272, 134694, 135672, 135694, 135486, 135580, 229816, 135006, 230163, 164846, 172826, 197926, 135281, 135299, 160505, 135604, 135635, 135259, 176867, 134831, 135285, 135494, 194238, 167656, 177391, 197206, 135485, 229786, 231449, 198578, 134902, 167446, 197923, 134841, 135575, 135605, 135640, 198570, 205752, 135354, 160518
              F2 = 134907, 134997, 135767, 220522, 188754, 168541, 135195, 231446, 233539, 135729, 231285, 161366, 231282, 233534, 231232, 231452, 230173, 231453, 233538, 197963, 134863, 229807, 135559, 135634, 198662, 134226, 161368, 203243, 135770, 144031, 135716, 206344, 206818, 135696, 198656, 135433, 135745, 203242, 135731, 231277, 222085, 135686, 194232
              F3 = 134981, 134570, 134556, 134934, 134962, 135009, 135018, 135738, 135275, 190586, 194272, 197125, 196835, 135021, 197116, 197199, 196841, 197250, 197409, 190571, 197265, 203225, 133918, 135251, 135424, 149574, 164863, 189901, 169489, 197117, 221052, 197213, 197274, 197327, 135202, 172825, 206328, 133939, 134509, 135584, 137342, 137348, 150008, 169575, 190585, 133921, 135196, 137291, 149571, 188724, 206336, 231255, 135341, 135448, 172829, 196840, 197094, 230169, 228444, 231258, 194339, 134971, 188726, 133894, 133924, 197249, 167452, 188734, 194263, 135099, 135162, 135420, 134970, 134992, 135266, 135484, 167550, 135396, 164837, 231251, 228440, 231447, 230497, 197225, 197520, 197595, 197676, 221053, 134989, 134990, 135010, 135319, 135079, 135223, 135351, 231261, 230230, 197114, 167531, 231253, 198439, 197410, 197746, 197747, 135678, 167654, 197436, 160507, 198005, 134500, 135177, 203292, 197691, 197519, 134955, 203240, 135536, 135610, 197991, 135339, 143336, 150304, 135622, 197419, 177396, 135505, 168559, 135540, 135257, 166207, 188718, 205754, 144656, 205758, 137363, 135105, 197965, 137283, 135534, 198572, 135075, 135068, 167527, 187198, 135567, 135572, 188737, 188741, 197078, 188752, 188732, 188756, 133919, 197221, 197082, 134018, 135382, 197938, 135163, 135069, 188727, 189911, 188715, 134638, 135161, 188722, 135104, 228427, 134422, 135100, 198658, 134464, 134901, 135641, 134946, 190587, 135300, 137295, 197763, 133893, 197096, 197219, 135650, 197562, 203300, 144661, 194318, 135215, 135371, 135411, 227584, 231250, 221172, 168218, 197434, 197701, 198568, 172830, 172891, 135190
              F4 = 134943, 135001, 135026, 134950, 134978, 194224, 134933, 135470, 194251, 197228, 135027, 194314, 194345, 206819, 133903, 135153, 135369, 197097, 135760, 194350, 197108, 197260, 203304, 203434, 134442, 135054, 135057, 135671, 143320, 143353, 161361, 133930, 135201, 135218, 137276, 150302, 168561, 166938, 169629, 134514, 134563, 135085, 135222, 135272, 135586, 137345, 192302, 134452, 134453, 135042, 135208, 135338, 135500, 135503, 135670, 137329, 137335, 135454, 135461, 172834, 188743, 229808, 134960, 203289, 206820, 135333, 220526, 133910, 135262, 135616, 135779, 137349, 149573, 197223, 135451, 231247, 135403, 135405, 231448, 231235, 228442, 231246, 228950, 229031, 233537, 197106, 198674, 205762, 134827, 231178, 197577, 197573, 221356, 222086, 160524, 198703, 135073, 135431, 160520, 135700, 137334, 137344, 149569, 149572, 197475, 167535, 135478, 197642, 197210, 228443, 133916, 197749, 135352, 150300, 137395, 197751, 134482, 135051, 135679, 134044, 197502, 137277, 138757, 138759, 135755, 197974, 134274, 135522, 197962, 135303, 164811, 198420, 135768, 197272, 198483, 135124, 135214, 135771, 197394, 150005, 198193, 206326, 194220, 134691, 135766, 137362, 135684, 197570, 137385, 198530, 137341, 144655, 149996, 167803, 188733, 168558, 172828, 172832, 197073, 194260, 197204, 135243, 137387, 133932, 135680, 133902, 135228, 160516, 135183, 135191, 137339, 135414, 190581, 134686, 135471, 231281, 203226, 164842, 194340, 197640, 149994, 166940, 135591, 133899, 203252, 177394, 137340, 190453, 229809, 228439, 233535, 134968, 134975, 135286, 137391, 197972, 135545, 137278, 197663, 133897, 188736
              F5 = 229805, 137350, 135531, 135565, 135489, 135397, 206343, 135541, 135514, 135334
              F6 = 137383, 231318, 231450, 231454, 135295, 137384, 203223, 135727, 194228"

#run analysis
model <- mirt(data=QSEN[, as.character(unlist(factor_items))], 
              model=model_syn, itemtype = "2PL", method = "QMCEM",
              technical = list(removeEmptyRows = TRUE, NCYCLES = 2000))

saveRDS(model, paste0("QSEN_analysis_result_", date, ".rds"))

factor_load <- summary(model)$rotF

# item_coef <- coef(model, simplify = TRUE, IRTpars = TRUE)$items

item_f_load <- vector("list", length = length(factor_items))

for(i in 1:length(item_f_load)){
  item_f_load[[i]] <- as.data.frame(factor_load[which(rownames(factor_load) %in% factor_items[[i]]),])
}

# colors = c("#c74e46", "#eb8031", "#2962ff", "#675e5c", "#a5959a", "#e0e55b")

gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

colors = gg_color_hue(6)

pdf("QSEN_exploratory.pdf")
#Factor 1
ggplot(data = item_f_load[[1]], aes(x = F1)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[1]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("QSEN: ", factors[1], " - Item Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[1]]$F1), 3),
                        ", SD = ", round(sd(item_f_load[[1]]$F1), 3))) +
  theme_bw()

#Factor 2
ggplot(data = item_f_load[[2]], aes(x = F2)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[2]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("QSEN: ", factors[2], " - Item Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[2]]$F2), 3),
                        ", SD = ", round(sd(item_f_load[[2]]$F2), 3))) +
  theme_bw()

#Factor 3
ggplot(data = item_f_load[[3]], aes(x = F3)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[3]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("QSEN: ", factors[3], " - Item Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[3]]$F3), 3),
                        ", SD = ", round(sd(item_f_load[[3]]$F3), 3))) +
  theme_bw()

#Factor 4
ggplot(data = item_f_load[[4]], aes(x = F4)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[4]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("QSEN: ", factors[4], " - Item Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[4]]$F4), 3),
                        ", SD = ", round(sd(item_f_load[[4]]$F4), 3))) +
  theme_bw()

#Factor 5
ggplot(data = item_f_load[[5]], aes(x = F5)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[5]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("QSEN: ", factors[5], " - Item Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[5]]$F5), 3),
                        ", SD = ", round(sd(item_f_load[[5]]$F5), 3))) +
  theme_bw()

#Factor 6
ggplot(data = item_f_load[[6]], aes(x = F6)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[6]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("QSEN: ", factors[6], " - Item Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[6]]$F6), 3),
                        ", SD = ", round(sd(item_f_load[[6]]$F6), 3))) +
  theme_bw()

dev.off()


################################################################################
########################### Nursing_Process ####################################
################################################################################

#using only data on Nursing_Process outcomes
Nursing_Process <- outcomes_data[which(outcomes_data$OutcomeTypeName == "Nursing Process"), 
                      c("BookletID", "qbtbQuestionID", "BatchID", 
                        "IsCorrect", "OutcomeID", 
                        "AssessmentID", "TestName", "OutcomeDescription",
                        "OutcomeTypeID", "OutcomeTypeName")]

#remove original dataset to save memory
rm(outcomes_data)
gc()

#mapping out which items load onto each factor
outcome_map <- unique(Nursing_Process[, c("qbtbQuestionID", "OutcomeDescription")])

#eliminating extraneous columns before spreading data
Nursing_Process_test <- Nursing_Process[,c("BookletID", "qbtbQuestionID",  
                     "IsCorrect")]

#moving data into wide format for use with mirt
Nursing_Process_wide <- Nursing_Process_test %>%
  spread(qbtbQuestionID, IsCorrect)

#identifying items with 0 variance in responses
bad_items <- NULL

for(j in 2:ncol(Nursing_Process_wide)){
  if(sum(!is.na(unique(Nursing_Process_wide[, j]))) < 2){
    bad_items <- c(bad_items, colnames(Nursing_Process_wide[j]))
  }
}

#removing those items from the item map
outcome_map <- outcome_map[which(!(outcome_map$qbtbQuestionID %in% bad_items)),]

#preparing lists of the items loading onto each factor
factors <- unique(outcome_map$OutcomeDescription)
factor_items <- vector("list", length(factors))

for(i in 1:length(factors)){
  factor_items[[i]] <- c(outcome_map[which(outcome_map[, "OutcomeDescription"] == factors[i]), "qbtbQuestionID"])
}

#formatting lists of items loading onto each factor for mirt model syntax
factor_syn <- vector("list", length(factors))
for(i in 1:length(factors)){
  factor_syn[[i]] <- paste0("F",i," = ", paste(factor_items[[i]], collapse = ", "))
}

#output the resulting string
sink(file = "Nursing_Process_mirt_model.txt")
cat(paste0(unlist(factor_syn), sep = "\n"))
sink()

#this doesn't work yet - may need to include data in mirt.model() 
# model_syn <- mirt.model(file = "mirt_model.txt")

#pasted in from mirt_model.txt
#Nursing Process - only keeping 2013 factors
model_syn <- "F1 = 7588384, 7588401, 7588404, 7588392, 7588393, 7588395, 7588410, 7588411, 7588343, 7588344, 7588406, 7588408, 7588331, 7588338, 7588418, 7588419, 7588360, 7588361, 7588362, 7588379, 7588347, 7588363, 7588365, 7588374, 7588381, 7588428, 7588429, 7588442, 7588444, 7588446, 7588460, 7588476, 7588434, 7588435, 7588467, 7588468, 7588469, 7588405, 7588407, 7588341, 7588346, 7588371, 7588373, 7588380, 7588382, 7588423, 7588430, 7588441, 7588455, 7588457, 7588422, 7588424, 7588431, 7588438, 7588449, 7588456, 7588465, 7588474, 7588481, 7588488, 7588490, 7588506, 7588471, 7588484, 7588501, 7588502, 7588504, 7588480, 7588498, 7588505, 7588478, 7588492, 7588494, 3589568, 3589551, 3589552, 3589553, 3589601, 3589603, 3589618, 3589619, 3589634, 3589635, 3589654, 3589670, 3589558, 3589560, 3589575, 3589576, 3589571, 3589580, 3589686, 3589523, 3589546, 3589548, 3589589, 3589596, 3589598, 3589605, 3589543, 3589611, 3589628, 3589657, 3589671, 3589673, 3589680, 3589682, 3589689, 3589691, 3644112, 3589660, 3589662, 3589675, 3589678, 3589693, 3644111, 3589579, 3589581, 3589583, 3589540, 3589554, 3589597, 3589599, 3589604, 3589608, 3589615, 3589622, 3589633, 3589658, 3589688, 3589690, 6983209, 6983225, 6983244, 6983261, 6983202, 6983218, 6983219, 6983237, 6983254, 6983267, 6983285, 6983301, 6983304, 6983317, 6983354, 6983205, 6983216, 6983232, 6983257, 6983264, 6983266, 6983271, 6983280, 6983291, 6983298, 6983300, 6983307, 6983348, 6983350, 6983355, 6983364, 6983366, 6983373, 7724503, 7724505, 7724512, 6983369, 6983370, 7724502, 7724515, 7724521, 6983277, 6983278, 6983279, 6983293, 6983311, 6983312, 6983326, 6983359, 6983361, 6983377, 7724524, 7724525, 7724526, 6983215, 6983222, 6983224, 6983233, 6983247, 6983249, 6983263, 6983288, 6983290, 6983297, 6983299, 6983306, 6983313, 6983322, 6983331, 6983333, 6983340, 6983356, 6983358, 6983374, 7724504, 7724511, 7724513, 7724522, 7724529, 7320971, 7320984, 7320986, 7321018, 7321019, 7321021, 7321035, 7321037, 7321052, 7321053, 7321069, 7321070, 7321085, 7321086, 7321101, 7321118, 7321119, 7320978, 7320994, 7320995, 7321009, 7321028, 7321044, 7321045, 7321046, 7321062, 7321077, 7321096, 7321110, 7320981, 7320990, 7321006, 7321008, 7321015, 7321017, 7321042, 7321049, 7321056, 7321074, 7321090, 7321092, 7321097, 7321099, 7321106, 7321115, 7321133, 7321140, 7321142, 7321147, 7321111, 7321127, 7321144, 7320975, 7321000, 7321016, 7321023, 7321025, 7321032, 7321034, 7321055, 7321066, 7321073, 7321082, 7321100, 7321107, 7321109, 7321139, 5520803, 5520804, 5520819, 5520792, 5520793, 5520817, 5520897, 5520906, 5520831, 5520840, 5520885, 5520836, 5520838, 5520851, 5520813, 5520893, 5520895, 5520828, 5520829, 5520843, 5520844, 5520856, 5520858, 5520865, 5520853, 5520870, 5520846, 5520860, 5520863, 5520935, 5520952, 5520911, 5520912, 5520913, 5520927, 5520928, 5520929, 5520943, 5520944, 5520945, 5520946, 5520961, 5520963, 5520955, 5520789, 5520908, 5520922, 5520924, 5520931, 5520933, 5520940, 5520949, 5520956, 5520965, 5520807, 5520889, 5520898, 5520900, 5520823, 5520857, 5520909, 5520914, 5520923, 5520925, 5520932, 5520934, 5520941, 5520950, 5520964, 5470675, 5470690, 5470699, 5470717, 5470731, 5470733, 5470781, 5470814, 5470815, 5470831, 5470832, 5470707, 5470723, 5470724, 5470739, 5470741, 5470772, 5470789, 5470792, 5470808, 5470809, 5470822, 5470824, 5470825, 5470826, 5470686, 5470704, 5470711, 5470738, 5470768, 5470788, 5470793, 5470813, 5470836, 5470687, 5470701, 5470710, 5470719, 5470721, 5470726, 5470746, 5470753, 5470776, 5470780, 5470785, 5470794, 5470805, 5470821, 5470843, 5470828, 5470837, 5470844, 5470846, 7843759, 7843770, 7843761, 7843775, 7843776, 7843763, 7843765, 7843774, 7843755, 7843766, 7843771, 7843780, 7844778, 7844779, 7844780, 7844788, 7844789, 7844767, 7844774, 7844776, 7844783, 7844792, 7844795, 7844796, 7844794, 7844768, 7844784, 7844793, 7494510, 7494507, 7494514, 7494534, 7494539, 7494536, 7494537, 7494555, 7494568, 7494569, 7494559, 7494566, 7494591, 7673583, 7673590, 7494512, 7494513, 7494527, 7494528, 7494529, 7494543, 7494544, 7494546, 7494563, 7494578, 7673586, 7494570, 7494571, 7494572, 7494588, 7494508, 7494524, 7494526, 7494542, 7494551, 7494556, 7494574, 7494576, 7673589, 7673591, 5128272, 3655082, 5128269, 5128275, 5128271, 5128273, 7891647, 7891652, 7891654, 7891653, 7891649, 5151987, 5151991, 5151992
              F2 = 7588385, 7588403, 7588336, 7588412, 7588388, 7588333, 7588368, 7588369, 7588375, 7588377, 7588426, 7588349, 7588358, 7588415, 7588462, 7588452, 7588389, 7588400, 7588414, 7588332, 7588366, 7588432, 7588473, 7588463, 7588508, 7588486, 7588487, 7588503, 7588482, 7588507, 7588479, 7588510, 3589569, 3589585, 3589586, 3589587, 3589519, 3589520, 3589533, 3589534, 3589550, 3589620, 3589651, 3589667, 3589684, 3589525, 3589527, 3589566, 3589521, 3589532, 3589539, 3589616, 3589542, 3589544, 3589545, 3589595, 3589609, 3589610, 3589612, 3589644, 3589632, 3589646, 3589648, 3589676, 3589556, 3589563, 3589529, 3589531, 3589547, 3589549, 3589590, 3589629, 3589647, 3589649, 3589683, 6983212, 6983226, 6983229, 6983242, 6983260, 6983200, 6983268, 6983270, 6983336, 6983221, 6983275, 6983330, 6983341, 7724514, 7724501, 7724518, 6983294, 6983329, 6983343, 6983345, 6983346, 6983360, 6983362, 7724510, 6983213, 6983281, 7724520, 7320968, 7320969, 7320987, 7320988, 7321002, 7321003, 7321020, 7321036, 7321038, 7321051, 7321054, 7321071, 7321087, 7321088, 7321102, 7321103, 7321104, 7321121, 7320976, 7320996, 7321012, 7321013, 7321076, 7321093, 7321095, 7321033, 7321072, 7321081, 7321122, 7321112, 7321143, 7320980, 7320998, 7321007, 7321080, 7321084, 7321098, 7321125, 7321141, 5520786, 5520787, 5520801, 5520808, 5520815, 5520822, 5520824, 5520821, 5520901, 5520837, 5520812, 5520877, 5520878, 5520879, 5520826, 5520827, 5520849, 5520871, 5520845, 5520862, 5520919, 5520920, 5520937, 5520951, 5520926, 5520930, 5520962, 5520798, 5520814, 5520839, 5520850, 5520916, 5520959, 5470667, 5470681, 5470697, 5470698, 5470730, 5470705, 5470782, 5470800, 5470817, 5470708, 5470709, 5470725, 5470807, 5470842, 5470668, 5470684, 5470695, 5470718, 5470720, 5470743, 5470754, 5470761, 5470671, 5470703, 5470760, 5470762, 5470796, 7843756, 7844770, 7844769, 7844777, 7494525, 7494532, 7494550, 7494521, 7494552, 7494553, 7494582, 7494589, 7494545, 7494547, 7494560, 7494562, 7494549, 7494583, 7885564, 7885560, 5128268, 5128270, 7891648, 7891650, 5151988, 5151995, 5151994, 5151990
              F3 = 7588386, 7588334, 7588337, 7588345, 7588390, 7588413, 7588340, 7588352, 7588417, 7588420, 7588378, 7588372, 7588443, 7588461, 7588477, 7588436, 7588453, 7588454, 7588357, 7588364, 7588416, 7588439, 7588448, 7588450, 7588440, 7588472, 7588497, 7588499, 7588495, 3589584, 3589517, 3589600, 3589637, 3589652, 3589668, 3589669, 3589577, 3589564, 3589573, 3589582, 3589687, 3715178, 3589626, 3589627, 3589642, 3589643, 3589623, 3589639, 3589641, 3589655, 3589659, 3589692, 3589694, 3589565, 3589572, 3589574, 3589522, 3589538, 3589588, 3589638, 3589640, 3589656, 3589665, 6983243, 6983259, 6983262, 6983234, 6983235, 6983250, 6983252, 6983303, 6983334, 6983335, 6983351, 6983368, 6983246, 6983248, 6983296, 6983305, 6983357, 6983375, 7724519, 7724516, 7724530, 6983276, 6983327, 6983328, 6983344, 6983376, 7724507, 7724508, 7724509, 6983208, 6983238, 6983240, 6983256, 6983258, 6983265, 6983272, 6983349, 6983363, 6983365, 6983372, 7724506, 7320970, 7321001, 7321004, 7321068, 7321136, 7320977, 7320979, 7321010, 7321026, 7321029, 7321043, 7321063, 7321079, 7320974, 7320992, 7321031, 7321040, 7321108, 7321131, 7321129, 7320973, 7320982, 7320991, 7321005, 7321030, 7321057, 7321059, 7321075, 7321091, 7321145, 7321146, 5520802, 5520818, 5520788, 5520806, 5520881, 5520883, 5520890, 5520892, 5520842, 5520887, 5520888, 5520902, 5520904, 5520894, 5520896, 5520847, 5520867, 5520874, 5520852, 5520869, 5520859, 5520861, 5520936, 5520953, 5520910, 5520791, 5520915, 5520958, 5520816, 5520882, 5520891, 5520907, 5520841, 5520848, 5520855, 5520873, 5520875, 5520957, 5470689, 5470700, 5470732, 5470748, 5470764, 5470765, 5470766, 5470816, 5470722, 5470740, 5470742, 5470756, 5470757, 5470758, 5470774, 5470775, 5470727, 5470736, 5470777, 5470779, 5470786, 5470795, 5470669, 5470685, 5470728, 5470735, 5470751, 5470771, 5470838, 7843768, 7843769, 7843778, 7843758, 7843772, 7843757, 7843764, 7843773, 7843782, 7844781, 7844771, 7844772, 7844773, 7844785, 7844775, 7844791, 7494511, 7494519, 7494516, 7494548, 7494538, 7494554, 7494564, 7494575, 7494561, 7494577, 7673584, 7673582, 7885562, 5151986, 5151993
              F4 = 7588387, 7588342, 7588359, 7588383, 7588397, 7588350, 7588370, 7588376, 7588356, 7588445, 7588437, 7588470, 7588396, 7588398, 7588339, 7588348, 7588425, 7588464, 7588483, 7588485, 7588475, 7588489, 7588500, 7588493, 3589567, 3589570, 3589535, 3589536, 3589602, 3589561, 3589562, 3589578, 3589528, 3589555, 3589621, 3589593, 3589645, 3589666, 3589606, 3589624, 3589674, 3589681, 6983228, 6983217, 6983220, 6983269, 6983287, 6983337, 6983367, 6983207, 7724517, 6983292, 7724527, 6983231, 6983338, 7320985, 7321105, 7321120, 7321135, 7321137, 7321011, 7321027, 7321078, 7320972, 7320983, 7320999, 7321024, 7321047, 7321058, 7321124, 7321113, 7321050, 7321114, 7321116, 7321134, 5520797, 5520799, 5520796, 5520833, 5520820, 5520903, 5520834, 5520835, 5520810, 5520811, 5520876, 5520868, 5520918, 5520954, 5520917, 5520947, 5520832, 5520866, 5470680, 5470682, 5470714, 5470715, 5470716, 5470747, 5470797, 5470759, 5470841, 5470679, 5470693, 5470702, 5470713, 5470829, 5470694, 5470835, 7843767, 7843760, 7843777, 7843779, 7843781, 7844790, 7844782, 7494580, 7673587, 7494586, 7494515, 7494522, 7494531, 7494558, 7885561, 7885563, 5128274, 7891651
              F5 = 7588399, 7588433, 7588447, 7588458, 7588402, 7588335, 7588351, 7588353, 7588354, 7588367, 7588451, 7588391, 7588355, 7588421, 7588466, 7588491, 7588394, 7588409, 7588427, 7588459, 7588496, 7588509, 3589518, 3589617, 3589636, 3589650, 3589653, 3589685, 3589559, 3589592, 3589594, 3589625, 3589557, 3589516, 3589591, 3589607, 3589614, 3589630, 3589664, 3589661, 3589677, 3589679, 3589515, 3589524, 3589613, 3589631, 3589663, 3589672, 6983236, 6983253, 6983214, 6983223, 6983230, 6983239, 6983241, 6983255, 6983289, 6983332, 6983227, 6983352, 6983353, 6983371, 7724528, 6983342, 6983378, 6983379, 6983347, 7321138, 7320993, 7321060, 7321061, 7321094, 7320997, 7321022, 7321065, 7321067, 7321083, 7321117, 7321126, 7321128, 7321130, 7320989, 7321014, 7321039, 7321041, 7321048, 7321064, 7321089, 7321123, 7321132, 5520886, 5520854, 5520794, 5520795, 5520809, 5520960, 5520921, 5520938, 5520790, 5520899, 5520872, 5520942, 5520800, 5520805, 5520880, 5520884, 5520905, 5520825, 5520830, 5520864, 5520939, 5470673, 5470683, 5470734, 5470750, 5470767, 5470706, 5470823, 5470840, 5470670, 5470688, 5470745, 5470763, 5470818, 5470820, 5470827, 5470678, 5470755, 5470769, 5470801, 5470819, 7843762, 7843783, 7844787, 7494523, 7494557, 7494579, 7494585, 7673585, 7673588, 7494517, 7494565, 7494567, 7494581, 7494590, 5128276, 7891646, 5151989"

#run analysis
model <- mirt(data=Nursing_Process_wide[, as.character(unlist(factor_items))], 
              model=model_syn, itemtype = "2PL", method = "QMCEM",
              technical = list(removeEmptyRows = TRUE, NCYCLES = 500))


saveRDS(model, paste0("Nursing_Process_analysis_result_", date, ".rds"))

factor_load <- summary(model)$rotF

item_coef <- coef(model, simplify = TRUE, IRTpars = TRUE)$items

item_f_load <- vector("list", length = length(factor_items))

for(i in 1:length(item_f_load)){
  item_f_load[[i]] <- as.data.frame(factor_load[which(rownames(factor_load) %in% factor_items[[i]]),])
}

# colors = c("#c74e46", "#eb8031", "#2962ff", "#675e5c", "#a5959a", "#e0e55b")

gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

colors = gg_color_hue(6)

pdf("K:/AscendKC/Corp/R_and_D/1-USERS/Jennifer Brussow/Outcome Modeling/Nursing_Process_exploratory.pdf")
#Factor 1
ggplot(data = item_f_load[[1]], aes(x = F1)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[1]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("Nursing Process: ", factors[1], "\nItem Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[1]]$F1), 3),
                        ", SD = ", round(sd(item_f_load[[1]]$F1), 3))) +
  theme_bw()

#Factor 2
ggplot(data = item_f_load[[2]], aes(x = F2)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[2]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("Nursing Process: ", factors[2], " - Item Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[2]]$F2), 3),
                        ", SD = ", round(sd(item_f_load[[2]]$F2), 3))) +
  theme_bw()

#Factor 3
ggplot(data = item_f_load[[3]], aes(x = F3)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[3]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("Nursing Process: ", factors[3], "\nItem Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[3]]$F3), 3),
                        ", SD = ", round(sd(item_f_load[[3]]$F3), 3))) +
  theme_bw()

#Factor 4
ggplot(data = item_f_load[[4]], aes(x = F4)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[4]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("Nursing Process: ", factors[4], "\nItem Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[4]]$F4), 3),
                        ", SD = ", round(sd(item_f_load[[4]]$F4), 3))) +
  theme_bw()

#Factor 5
ggplot(data = item_f_load[[5]], aes(x = F5)) + 
  geom_histogram(binwidth = 0.05, alpha = 0.7, fill = colors[5]) + 
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, .2),
                     labels = seq(-1, 1, .2)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Factor Loadings", y = "Count", 
       title = paste0("Nursing Process: ", factors[5], "\nItem Loadings"),
       caption = paste0("Mean = ", round(mean(item_f_load[[5]]$F5), 3),
                        ", SD = ", round(sd(item_f_load[[5]]$F5), 3))) +
  theme_bw()


dev.off()


person_scores <- fscores(model, QMC = TRUE, converge_info = TRUE)
cov(person_scores[,1:5])

